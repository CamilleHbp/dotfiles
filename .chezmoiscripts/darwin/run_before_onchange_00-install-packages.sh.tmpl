#!/bin/sh

# ---------------------------------------------------------------------------- #
#                          Unofficial Bash Strict Mode                         #
# ---------------------------------------------------------------------------- #
# See http://redsymbol.net/articles/unofficial-bash-strict-mode/
# -e: exit on error
# -u: exit on unset variables
# -o pipefail: prevents errors in a pipeline from being masked 
set -euo pipefail
# IFS (Internal Field Separator): controls what Bash calls word splitting.
# When set to a string, each character in the string is considered by Bash to separate words
IFS=$'\n\t'

########### Tools installation

# Set a SUDO_USER variable, because some of the following installations require sudo
SUDO_USER=$(whoami)

# ---------------------------------------------------------------------------- #
#                                     XCode                                    #
# ---------------------------------------------------------------------------- #
# Install XCode
if ! chezmoi="$(command -v chezmoi)"; then
  xcode-select --install
fi
# Update XCode CLI tools
PROD=$(softwareupdate -l | grep "\*.*Command Line" | head -n 1 | awk -F"*" '{print $2}' | sed -e 's/^ *//' | tr -d '\n') || true

if [[ ! -z "$PROD" ]]; then
  softwareupdate -i "$PROD" --verbose
fi

# ---------------------------------------------------------------------------- #
#                                   Homebrew                                   #
# ---------------------------------------------------------------------------- #

# ------------------------------- Installation ------------------------------- #
# Install Homebrew if not installed
if test ! $(which brew); then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# Update Homebrew
brew upgrade && brew upgrade && brew cleanup

# ------------------------------- Package list ------------------------------- #
{{ $brews := list
  "docker"
  "fzf"
  "git"
  "python"
  "thefuck"
  "zsh"
-}}

{{ $casks := list
  "iterm2"
  "nextcloud"
  "temurin"
  "visual-studio-code"
  "vlc"
-}}

# Personal packages
{{ if .personal -}}
  {{   $brews = concat $brews (list
    "nvim"
  ) -}}

  # TODO: fix jDownloader's install
  {{ $casks = concat $casks (list
    "1password/tap/1password-cli"
    "alfred"
    "appcleaner"
    "brave-browser"
    "calibre"
    "c0re100-qbittorrent"
    "dropbox"
    "homebrew/cask-drivers/wacom-tablet"
    "krita"
    "macfuse"
    "onyx"
    "path-finder"
    "protonvpn"
    "spotify"
    "steermouse"
    "vlc"
  ) -}}
{{ end -}}

# --------------------------- Package installation --------------------------- #
brew bundle --no-lock --file=/dev/stdin <<EOF
{{ range ($brews | sortAlpha | uniq) -}}
brew "{{ . }}"
{{ end -}}
{{ range ($casks | sortAlpha | uniq) -}}
cask "{{ . }}"
{{ end -}}
EOF
