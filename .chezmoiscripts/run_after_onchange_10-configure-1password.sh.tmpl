#!/bin/sh

# ---------------------------------------------------------------------------- #
#                          Unofficial Bash Strict Mode                         #
# ---------------------------------------------------------------------------- #
# See http://redsymbol.net/articles/unofficial-bash-strict-mode/
# -e: exit on error
# -u: exit on unset variables
# -o pipefail: prevents errors in a pipeline from being masked 
set -euo pipefail
# IFS (Internal Field Separator): controls what Bash calls word splitting.
# When set to a string, each character in the string is considered by Bash to separate words
IFS=$'\n\t'

# ------------------ Exit if this is not a personal machine ------------------ #
{{- if not .personal -}}
    return 0
{{- end -}}

# ---------------------------------------------------------------------------- #
#                        Add 1Password acount and signin                       #
# ---------------------------------------------------------------------------- #
# This command can be used with arguments, but we need to figure out how to add them securely (github secrets?)
op account add --address {{ .op_domain }}.1password.com --email {{ .op_email }} --secret-key {{ .op_secret }}
eval $(op signin)

mkdir -p ~/.ssh
if [ ! -f "id_ed25519" ]; then
    touch ~/.ssh/id_ed25519 && chmod 0600 ~/.ssh/id_ed25519
    echo {{ (onepasswordDetailsFields "w3rasa7gfmsvb6vkxvufledjny").private_key.value | quote }} >> ~/.ssh/id_ed25519
fi
if [ ! -f "id_ed25519.pub" ]; then
    touch ~/.ssh/id_ed25519.pub && chmod 0644 ~/.ssh/id_ed25519.pub
    echo {{ (onepasswordDetailsFields "w3rasa7gfmsvb6vkxvufledjny").public_key.value | quote }} >> ~/.ssh/id_ed25519.pub
fi
if [ ! -f "id_ed25519_elbowarrior" ]; then
    touch ~/.ssh/id_ed25519_elbowarrior && chmod 0600 ~/.ssh/id_ed25519_elbowarrior
    echo {{ (onepasswordDetailsFields "l6nqfvclhwzs3432g3x4ppjrti").private_key.value | quote }} >> ~/.ssh/id_ed25519_elbowarrior
fi
if [ ! -f "id_ed25519_elbowarrior.pub" ]; then
    touch ~/.ssh/id_ed25519_elbowarrior.pub && chmod 0644 ~/.ssh/id_ed25519_elbowarrior.pub
    echo {{ (onepasswordDetailsFields "l6nqfvclhwzs3432g3x4ppjrti").public_key.value | quote }} >> ~/.ssh/id_ed25519_elbowarrior.pub
fi

# ---------------------------------------------------------------------------- #
#                           Add ssh keys to ssh-agent                          #
# ---------------------------------------------------------------------------- #
eval "$(ssh-agent)"
ssh-add ~/.ssh/id_ed25519
ssh-add ~/.ssh/id_ed25519_elbowarrior